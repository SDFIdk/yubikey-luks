#!/bin/bash
#
# This is /sbin/ykluks-keyscript, which gets called when unlocking the disk
#

#Set this in case the value is missing in /etc/ykluks.cfg
CONCATENATE=0
HASH=0
WELCOME_TEXT="Please insert YubiKey and press enter or enter a valid passphrase ..."
YUBIKEY_SLOT=2
#YUBIKEY_CHALLENGE="YubiKey Password" Set this in /etc/ykluks.conf to enable 1FA

# Import config
if [ -f /etc/ykluks.cfg ]
then
    # shellcheck source=ykluks.cfg
    . /etc/ykluks.cfg
fi

message() {
    if [ -x /bin/plymouth ] && plymouth --ping
    then
        plymouth message --text="$*"
    else
        echo "$@" >&2
    fi
    return
}

# Check if YubiKey is missing or 1FA is enabled
if [ -z "$YUBIKEY_CHALLENGE" ] || ! ykinfo -q -"$YUBIKEY_SLOT" >/dev/null 2>&1
then
    if [ -x /bin/plymouth ] && plymouth --ping
    then
        PASSWORD="$(plymouth ask-for-password --prompt "$WELCOME_TEXT")"
    else
        PASSWORD="$(/lib/cryptsetup/askpass "$WELCOME_TEXT")"
    fi
fi

# Check if user has press enter after inserting YubiKey (remove 1FA warning)
if [ -z "$PASSWORD" ] && [ -n "$YUBIKEY_CHALLENGE" ]
then
    PASSWORD="$YUBIKEY_CHALLENGE"
fi

# Check if YubiKey has been inserted during promt
if ykinfo -q -"$YUBIKEY_SLOT" > /dev/null 2>&1
then
    message "Accessing yubikey..."
    if [ "$HASH" = "1" ]
    then
        PASSWORD=$(echo -n "$PASSWORD" | sha256sum | awk '{print $1}')
    fi
    RESPONCE="$(echo -n "$PASSWORD" | ykchalresp -"$YUBIKEY_SLOT" -i- 2>/dev/null || true)"
    if [ "$RESPONCE" ]
    then
        message "Retrieved the response from the Yubikey"
        if [ "$CONCATENATE" = "1" ]
        then
            echo -n "$PASSWORD$RESPONCE"
        else
            echo -n "$RESPONCE"
        fi
    else
        message "Failed to retrieve the response from the Yubikey"
    fi
else
    echo -n "$PASSWORD"
fi

exit
